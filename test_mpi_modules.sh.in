#!/bin/bash -l
#OAR -l /nodes=2/core=1
#OAR -n ModuleTest_MPI

TEST_DIR="@CMAKE_BINARY_DIR@"
CMAKE_CMD="@CMAKE_COMMAND@"
CTEST_CMD="@CMAKE_CTEST_COMMAND@"


# Debug info
echo "List of nodes: $(cat ${OAR_NODE_FILE} | tr '\n' ' ')"


# submission group
CDASH_GROUP_NAME="Nightly"

# define SITE_NAME
#NODE1=$(head -n 1 ${OAR_NODE_FILE})
#NODE2=$(tail -n 1 ${OAR_NODE_FILE})
#SITE_NAME="${NODE1}+${NODE2}"
CDASH_SITE_NAME="$(hostname -f | cut -f 2- -d '.')"
echo "SITE_NAME = ${SITE_NAME}"

# List all MPI modules
MPI_MODULE_LIST="$(cat ${TEST_DIR}/mpi_module_list.txt)"

# Test all modules
for MPI_MODULE_NAME in ${MPI_MODULE_LIST} ; do

    echo
    echo "-------------------------"
    echo "Testing MPI module '${MPI_MODULE_NAME}'"

    # define build name
    MODULE_NAME_SAFE="$(echo ${MPI_MODULE_NAME} | tr '/' '_')"
    CDASH_BUILD_NAME="MPI Module ${MODULE_NAME_SAFE}"

    # clean environment and load the module
    module purge
    module load "${MPI_MODULE_NAME}"

    export CDASH_GROUP_NAME CDASH_SITE_NAME CDASH_BUILD_NAME
    "${TEST_DIR}/test_and_submit.sh"

done

# clean up the environment
module purge
